# üö® Tudushka Server Issues & Fix Plan

## üìä –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞

### ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç:
- **Frontend**: https://tudushka.ru - React –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
- **SSL/HTTPS**: –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã Let's Encrypt —Ä–∞–±–æ—Ç–∞—é—Ç
- **PostgreSQL**: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–ø—É—â–µ–Ω–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞
- **Gunicorn**: Django –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ —á–µ—Ä–µ–∑ systemd
- **Nginx**: –ü—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è frontend + API

### ‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏:

## 1. üî¥ Django API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 400 Bad Request

**–ü—Ä–æ–±–ª–µ–º–∞**: –í—Å–µ API endpoints (/api/tasks/, /api/users/, /api/chat/) –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç HTTP 400
**–°–∏–º–ø—Ç–æ–º—ã**: 
- `curl https://tudushka.ru/api/tasks/` ‚Üí 400 Bad Request
- Frontend –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "Load failed"
- Django –ª–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç 400 –±–µ–∑ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã**:
- CORS –ø—Ä–æ–±–ª–µ–º—ã –≤ production —Ä–µ–∂–∏–º–µ (DEBUG=False)
- –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–æ—Ä–Ω–µ–≤–æ–π API endpoint –≤ urls.py
- –ü—Ä–æ–±–ª–µ–º—ã —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
- Django middleware –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã

**–ü–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**:
1. –í–∫–ª—é—á–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω–æ DEBUG=True –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –æ—à–∏–±–æ–∫
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å CORS_ALLOWED_ORIGINS –≤ settings.py
3. –î–æ–±–∞–≤–∏—Ç—å –∫–æ—Ä–Ω–µ–≤–æ–π API endpoint: `path('api/', views.api_root)`
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Django middleware –ø–æ—Ä—è–¥–æ–∫
5. –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ Django
6. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å API endpoints –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ—Å—Ç–∏

## 2. üî¥ Telegram Bot –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

**–ü—Ä–æ–±–ª–µ–º–∞**: Systemd —Å–µ—Ä–≤–∏—Å tudushka-bot –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –ø–∞–¥–∞–µ—Ç
**–û—à–∏–±–∫–∞**: `Cannot close a running event loop`

**–ü—Ä–∏—á–∏–Ω–∞**: –ö–æ–Ω—Ñ–ª–∏–∫—Ç async/await –≤ python-telegram-bot library
**–°–∏–º–ø—Ç–æ–º—ã**:
- `systemctl status tudushka-bot` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç failed
- RuntimeWarning: coroutine 'Application.initialize' was never awaited

**–ü–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**:
1. –û–±–Ω–æ–≤–∏—Ç—å python-telegram-bot –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏
2. –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å telegram_bot.py –ø–æ–¥ –Ω–æ–≤—ã–π API –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
3. –ò—Å–ø—Ä–∞–≤–∏—Ç—å async/await —Å—Ç—Ä—É–∫—Ç—É—Ä—É –≤ start_bot.py
4. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è systemd
5. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –±–æ—Ç–∞ –æ—Ç–¥–µ–ª—å–Ω–æ –æ—Ç systemd

## 3. üü° Frontend "Load failed" –æ—à–∏–±–∫–∞

**–ü—Ä–æ–±–ª–µ–º–∞**: React –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ API
**–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ**: –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–û—à–∏–±–∫–∞: Load failed" –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ

**–ü—Ä–∏—á–∏–Ω—ã**:
- API endpoints –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç 400 (—Å–≤—è–∑–∞–Ω–æ —Å –ø—Ä–æ–±–ª–µ–º–æ–π #1)
- VITE_API_URL –≤ frontend —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ
- CORS –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –æ—Ç frontend –∫ API

**–ü–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**:
1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å Django API (–ø—Ä–æ–±–ª–µ–º–∞ #1)
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å environment variables –≤ frontend build
3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ CORS headers
4. –û–±–Ω–æ–≤–∏—Ç—å frontend –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è production

## 4. üîµ –£–¥–∞–ª–µ–Ω–∏–µ Anthropic AI

**–ó–∞–¥–∞—á–∞**: –£–±—Ä–∞—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É Anthropic –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
**–§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è**:
- `backend/settings.py` - —É–¥–∞–ª–∏—Ç—å ANTHROPIC_API_KEY
- `chat/views.py` - —É–¥–∞–ª–∏—Ç—å Anthropic provider
- `frontend/src/components/` - —É–±—Ä–∞—Ç—å –∏–∑ UI –≤—ã–±–æ—Ä–∞
- `users/models.py` - —É–¥–∞–ª–∏—Ç—å anthropic_api_key –ø–æ–ª—è
- `.env` - —É–¥–∞–ª–∏—Ç—å ADMIN_ANTHROPIC_API_KEY

**–ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π**:
1. –ù–∞–π—Ç–∏ –≤—Å–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è "anthropic" –≤ –∫–æ–¥–µ
2. –£–¥–∞–ª–∏—Ç—å Anthropic –∏–∑ AI providers
3. –û–±–Ω–æ–≤–∏—Ç—å UI –¥–ª—è –ø–æ–∫–∞–∑–∞ —Ç–æ–ª—å–∫–æ OpenAI –∏ Perplexity
4. –£–¥–∞–ª–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è anthropic –ø–æ–ª–µ–π
5. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –æ—Å—Ç–∞–≤—à–∏–º–∏—Å—è AI

## 5. üü° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

**–ü—Ä–æ–±–ª–µ–º—ã**:
- Nginx warning: proxy_headers_hash —Ä–∞–∑–º–µ—Ä
- Django staticfiles –Ω–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –¥–ª—è production
- –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ü–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**:
1. –£–≤–µ–ª–∏—á–∏—Ç—å proxy_headers_hash_max_size –≤ nginx.conf
2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å gzip —Å–∂–∞—Ç–∏–µ –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
3. –î–æ–±–∞–≤–∏—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ API –æ—Ç–≤–µ—Ç–æ–≤
4. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å PostgreSQL –¥–ª—è production

---

## üìã –ü–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –§–∞–∑–∞ 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ API –æ—à–∏–±–∫–∏ (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –í–´–°–û–ö–ò–ô)
1. **–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Django API**:
   ```bash
   # –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤–∫–ª—é—á–∏—Ç—å DEBUG –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
   sed -i 's/DEBUG=False/DEBUG=True/' .env
   systemctl restart tudushka
   # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å API –∏ —Å–º–æ—Ç—Ä–µ—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏
   curl -v https://tudushka.ru/api/tasks/
   ```

2. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ CORS**:
   - –î–æ–±–∞–≤–∏—Ç—å tudushka.ru –≤ CORS_ALLOWED_ORIGINS
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å CORS middleware –≤ settings.py
   - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å –±—Ä–∞—É–∑–µ—Ä–∞

3. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ—Ä–Ω–µ–≤–æ–≥–æ API endpoint**:
   - –°–æ–∑–¥–∞—Ç—å views.api_root() –≤ backend/urls.py
   - –î–æ–±–∞–≤–∏—Ç—å –±–∞–∑–æ–≤—É—é API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

### –§–∞–∑–∞ 2: –£–¥–∞–ª–µ–Ω–∏–µ Anthropic (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –°–†–ï–î–ù–ò–ô)
1. **Backend –æ—á–∏—Å—Ç–∫–∞**:
   ```bash
   grep -r "anthropic" backend/ chat/ users/
   # –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è
   ```

2. **Frontend –æ—á–∏—Å—Ç–∫–∞**:
   ```bash
   grep -r "anthropic" frontend/src/
   # –£–¥–∞–ª–∏—Ç—å –∏–∑ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –≤—ã–±–æ—Ä–∞ AI
   ```

3. **Database migration**:
   ```bash
   python manage.py makemigrations
   python manage.py migrate
   ```

### –§–∞–∑–∞ 3: Telegram Bot (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –°–†–ï–î–ù–ò–ô)
1. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫**:
   ```bash
   pip install python-telegram-bot==20.8 --upgrade
   ```

2. **–ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å bot –∑–∞–ø—É—Å–∫**:
   - –ò—Å–ø—Ä–∞–≤–∏—Ç—å async —Å—Ç—Ä—É–∫—Ç—É—Ä—É
   - –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É systemd —Å–∏–≥–Ω–∞–ª–æ–≤

### –§–∞–∑–∞ 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –ù–ò–ó–ö–ò–ô)
1. **End-to-end —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**:
   - –¢–µ—Å—Ç –≤—Å–µ—Ö API endpoints
   - –¢–µ—Å—Ç frontend —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
   - –¢–µ—Å—Ç Telegram bot –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

2. **Performance –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏**:
   - Nginx –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
   - Django –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ
   - Static files –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

---

## üîß –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

```bash
# –°—Ç–∞—Ç—É—Å –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
systemctl status tudushka nginx postgresql tudushka-bot

# –ü—Ä–æ–≤–µ—Ä–∫–∞ API
curl -I https://tudushka.ru/api/tasks/

# –õ–æ–≥–∏ Django
journalctl -u tudushka -f

# –õ–æ–≥–∏ Nginx
tail -f /var/log/nginx/error.log

# –¢–µ—Å—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
sudo -u postgres psql -d tudushka_db -c "SELECT COUNT(*) FROM auth_user;"
```

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏

1. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –ü–æ—Å–ª–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤–µ—Ä–Ω—É—Ç—å DEBUG=False
2. **Backup**: –°–¥–µ–ª–∞—Ç—å snapshot —Å–µ—Ä–≤–µ—Ä–∞ –ø–µ—Ä–µ–¥ –∫—Ä—É–ø–Ω—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏
3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –°–ª–µ–¥–∏—Ç—å –∑–∞ –ª–æ–≥–∞–º–∏ –≤–æ –≤—Ä–µ–º—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π
4. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ö–∞–∂–¥–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ—Å—Ç–∏

---

**–°–æ–∑–¥–∞–Ω–æ**: 2025-08-10  
**–°—Ç–∞—Ç—É—Å**: –ì–æ—Ç–æ–≤ –∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: API –æ—à–∏–±–∫–∏ ‚Üí Anthropic —É–¥–∞–ª–µ–Ω–∏–µ ‚Üí Telegram bot ‚Üí –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è